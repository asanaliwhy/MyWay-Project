datasource db {
  provider = "postgresql"
}

generator client {
  provider = "prisma-client-js"
}

// --- Tenancy + Users ---

model User {
  id           String   @id @default(uuid())
  email        String   @unique
  passwordHash String
  name         String
  createdAt    DateTime @default(now())
  lastLogin    DateTime?

  memberships  OrgMembership[]
  enrollments  Enrollment[]
  createdCourses Course[] @relation("CourseCreator")
  
  quizAttempts      QuizAttempt[]
  flashcardSessions FlashcardSession[]
  progressEvents    ProgressEvent[]
  submissions       Submission[]
  threads           Thread[]
  replies           Reply[]
}

model Organization {
  id        String   @id @default(uuid())
  name      String
  plan      String   @default("Free")
  createdAt DateTime @default(now())

  memberships  OrgMembership[]
  courses      Course[]
  dailyMetrics DailyOrgMetric[]
}

model OrgMembership {
  id       String @id @default(uuid())
  orgId    String
  userId   String
  role     Role
  status   String @default("Active")

  organization Organization @relation(fields: [orgId], references: [id])
  user         User         @relation(fields: [userId], references: [id])

  @@unique([orgId, userId])
}

enum Role {
  ORGANIZER
  TEACHER
  STUDENT
}

// --- Courses ---

model Course {
  id          String   @id @default(uuid())
  orgId       String
  code        String
  title       String
  description String
  createdBy   String

  organization Organization @relation(fields: [orgId], references: [id])
  creator      User         @relation("CourseCreator", fields: [createdBy], references: [id])
  
  enrollments  Enrollment[]
  modules      Module[]
  assignments  Assignment[]
  threads      Thread[]
  metrics      CourseMetric[]
}

model Enrollment {
  id        String   @id @default(uuid())
  courseId  String
  userId    String
  role      String   // Specific role within course if different from org role
  createdAt DateTime @default(now())

  course    Course   @relation(fields: [courseId], references: [id])
  user      User     @relation(fields: [userId], references: [id])

  @@unique([courseId, userId])
}

model Module {
  id         String   @id @default(uuid())
  courseId   String
  title      String
  order      Int
  lockedRule String?

  course    Course     @relation(fields: [courseId], references: [id])
  materials Material[]
}

model Material {
  id             String   @id @default(uuid())
  moduleId       String
  type           String   // video / doc / link
  title          String
  sourceUrl      String?
  fileUrl        String?
  transcriptText String?

  module       Module      @relation(fields: [moduleId], references: [id])
  studyPacks   StudyPack[]
}

// --- AI Outputs ---

model StudyPack {
  id              String   @id @default(uuid())
  materialId      String
  createdBy       String
  status          String   // PENDING, GENERATED, FAILED
  createdAt       DateTime @default(now())
  publishedAt     DateTime?
  requiresApproval Boolean  @default(false)
  approvedBy      String?

  material        Material @relation(fields: [materialId], references: [id])
  summary         Summary?
  quizzes         Quiz[]
  flashcards      Flashcard[]
  sessions        FlashcardSession[]
}

model Summary {
  id          String    @id @default(uuid())
  studyPackId String    @unique
  content     Json      // Structured bullets + key concepts

  studyPack   StudyPack @relation(fields: [studyPackId], references: [id])
}

model Quiz {
  id          String    @id @default(uuid())
  studyPackId String
  version     Int       @default(1)
  metadata    Json      // Quiz settings, difficulty, etc.

  studyPack   StudyPack @relation(fields: [studyPackId], references: [id])
  questions   QuizQuestion[]
  attempts    QuizAttempt[]
}

model QuizQuestion {
  id          String   @id @default(uuid())
  quizId      String
  type        String   // MCQ, SHORT_ANSWER
  prompt      String
  options     Json     // Possible answers
  answerKey   Json     // Correct answer(s)
  explanation String?

  quiz       Quiz     @relation(fields: [quizId], references: [id])
}

model Flashcard {
  id          String    @id @default(uuid())
  studyPackId String
  front       String
  back        String
  tags        Json?

  studyPack   StudyPack @relation(fields: [studyPackId], references: [id])
}

// --- Learning + Progress ---

model QuizAttempt {
  id        String   @id @default(uuid())
  quizId    String
  userId    String
  score     Int
  answers   Json
  createdAt DateTime @default(now())

  quiz      Quiz     @relation(fields: [quizId], references: [id])
  user      User     @relation(fields: [userId], references: [id])
}

model FlashcardSession {
  id           String   @id @default(uuid())
  studyPackId  String
  userId       String
  knownCount   Int
  unknownCount Int
  durationSec  Int
  createdAt    DateTime @default(now())

  studyPack    StudyPack @relation(fields: [studyPackId], references: [id])
  user         User      @relation(fields: [userId], references: [id])
}

model ProgressEvent {
  id        String   @id @default(uuid())
  userId    String
  courseId  String
  eventType String   // MODULE_VIEWED, LESSON_COMPLETED, etc.
  payload   Json
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id])
}

// --- Assignments & Grading ---

model Assignment {
  id           String   @id @default(uuid())
  courseId     String
  title        String
  dueAt        DateTime
  points       Int
  instructions String
  status       String   // ACTIVE, ARCHIVED

  course       Course   @relation(fields: [courseId], references: [id])
  submissions  Submission[]
}

model Submission {
  id           String   @id @default(uuid())
  assignmentId String
  userId       String
  status       String   // SUBMITTED, GRADED, RE_SUBMIT_REQUESTED
  fileUrl      String?
  submittedAt  DateTime @default(now())
  grade        String?
  feedback     String?

  assignment   Assignment @relation(fields: [assignmentId], references: [id])
  user         User       @relation(fields: [userId], references: [id])
}

// --- Discussions ---

model Thread {
  id        String   @id @default(uuid())
  courseId  String
  createdBy String
  title     String
  body      String
  createdAt DateTime @default(now())

  course    Course   @relation(fields: [courseId], references: [id])
  creator   User     @relation(fields: [createdBy], references: [id])
  replies   Reply[]
}

model Reply {
  id        String   @id @default(uuid())
  threadId  String
  createdBy String
  body      String
  createdAt DateTime @default(now())

  thread    Thread   @relation(fields: [threadId], references: [id])
  creator   User     @relation(fields: [createdBy], references: [id])
}

// --- Analytics Metrics ---

model DailyOrgMetric {
  id             String   @id @default(uuid())
  orgId          String
  date           DateTime
  dau            Int
  wau            Int
  activationRate Float
  retention7d    Float
  runsCount      Int
  quizzesTaken   Int

  organization   Organization @relation(fields: [orgId], references: [id])

  @@unique([orgId, date])
}

model CourseMetric {
  id             String   @id @default(uuid())
  courseId       String
  date           DateTime
  avgProgress    Float
  avgScore       Float
  engagementRate Float

  course         Course   @relation(fields: [courseId], references: [id])

  @@unique([courseId, date])
}
